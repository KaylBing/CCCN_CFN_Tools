---
title: "Cluster Enrichment Analysis"
output: html_document
---
## Cluster Enrichment Analysis
The goal is identify clusters that are enriched for drug-affected sites (i.e., have more drug-affected sites than expected by chance). For each cluster, a Fisher Test on the 2x2 contingency table (drug affected sites in cluster, drug affected sites not in cluster, unaffected sites in cluster, unaffected sites not in cluster) will be performed. Because the test is being performed on many clusters, multiple testing correction using the Benjamini-Hochberg correction will be applied. This analysis will be performed for different groups of experiments. Some groups are replicates of a single drug/cell-line combo; other groups combine experiments on multiple drugs and/or cell-lines. For each group, a drug affected site is defined as a site where the median ratio (drug-treated vs. untreated) of all experiments in the group is at least 2.25-fold changed. Sites must be observed for at least two experiments in the group to be included.

Below is the list of cell-line/drug combinations tested. The short name, which will be used in plot and table labels, is shown in parenthesis. The number of replicates for each combo is given.
H3122/Crizotinib (h3122.criz): 5 experiments
H2228/Crizotinib (h2228.criz): 1 experiment
STE1/Crizotinib (ste1.criz): 1 experiment
HCC78/Crizotinib (hcc78.criz): 2 experiments

PC9/Erlotinib (pc9.erl): 5 experiments
HCC4006/Erlotinib (hcc4006.erl): 1 experiment
HCC827/Erlotinib (hcc827.erl): 1 experiment

H1781/Afatinib (h1781.afat): 1 experiment

H2286/Dasatinib (h2286.dasat): 1 experiment
H366/Dasatinib (h366.dasat): 1 experiment

Groups:
1. h3122.criz
2. hcc78.criz
3. pc9.erl
4. all.criz (h3122.criz, ste1.criz, hcc78.criz, h2228.criz)
5. all.erl (pc9.erl, hcc4006.erl, hcc827.erl)
6. all.dasat (h2286.dasat, h366.dasat)
7. all.drug (h3122.criz, ste1.criz, hcc78.criz, h2228.criz, pc9.erl, hcc4006.erl, hcc827.erl, h2286.dasat, h366.dasat, h1781.afat)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Setup: Set local paths for input files and desired location of output files; start Cytoscape
```{r set paths}

#Filepaths
#Input Data Files
data_path <- "/Users/karenross/Documents/Bioinformatics/PIR/GrimesGroupCollab/TKI-Data-Files-Final/"

#Function Files
code_path <- "/Users/karenross/Documents/Bioinformatics/PIR/GrimesGroupCollab/PTMs-to-CCCN-and-CFN/"

#Output Files
sig.site.meds.filepath = "/Users/karenross/Documents/Bioinformatics/PIR/GrimesGroupCollab/ClusterEnrichment-final/SigSitesMeds/"

results_table_file_path = "/Users/karenross/Documents/Bioinformatics/PIR/GrimesGroupCollab/ClusterEnrichment-final/"

heatmap_path_130.141.111 <- "/Users/karenross/Documents/Bioinformatics/PIR/GrimesGroupCollab/ClusterEnrichment-final/heatmaps-130.141.111/"

heatmap_path_180.173.39 <- "/Users/karenross/Documents/Bioinformatics/PIR/GrimesGroupCollab/ClusterEnrichment-final/heatmaps-180.173.39/"

heatmap_path_38.41.40 <- "/Users/karenross/Documents/Bioinformatics/PIR/GrimesGroupCollab/ClusterEnrichment-final/heatmaps-38.41.40/"

```

```{r load_packages}

library(plyr)
library(dplyr)
library(gplots)
library(RColorBrewer)
library(RCy3)
library(igraph)

#Start Cytoscape
cytoscapePing ()
cytoscapeVersionInfo ()

```


```{r load data objects and functions}

#Load data files
load(file=paste(data_path, "GZ_PPI_Networks2.RData", sep="")) #has gz.cf w/12461 rows and gz.cf.pruned w/9701 and has gzalltgene.physical.cfn.merged

CCCN_sites_file <- paste(data_path,"sites_by_cluster.txt", sep="")
CCCN_sites <- read.table(CCCN_sites_file, sep = "\t", stringsAsFactors = F, header=T)

#Load functions
source(paste(code_path, "tki-functions-final.R", sep=""))
source(paste(code_path, "Generate_CCCN_CFN.R", sep=""))


```


```{r find enriched clusters}

#gz.cf is the table of all nodes (genes and PTMs) in the CFN/CCCN; remove rows with gene name "NA" from gz.cf
gz.cf.good.gene.names <- gz.cf[which(!(gz.cf$Gene.Name == "NA")),]

#CCCN_sites is the table showing the cluster each sites belongs to; remove rows from CCCN_sites where gene name is NA
CCCN_sites <- CCCN_sites[CCCN_sites$Site %in% gz.cf.good.col.names.na$id,]

#Standardize the experiment names in the column headings of gz.cf so the labels on the plots will look better
gz.cf.good.col.names <- gz.cf.good.gene.names

good.col.names <- c("id", "Gene.Name", "Approved.Name", "Hugo.Gene.Family", "HPRD.Function", "nodeType", "Domains", "Compartment", "Compartment.Overview", "Total", "Median", "Max", "No.Samples", "No.Modifications", "ppidegree", "ppibetween", "SEPTM.H3122.Criz.1", "SEPTM.H3122.Criz.2", "SEPTM.H3122.Criz.3", "SEPTM.H3122.PR171.1", "SEPTM.H3122.PR171.2", "SEPTM.H3122.PR171.3", "SEPTM.PC9.Erl.1", "SEPTM.PC9.Erl.2", "SEPTM.PC9.Erl.3", "SEPTM.PC9.PR171.1", "SEPTM.PC9.PR171.2", "SEPTM.PC9.PR171.3", "TC.H1781.Afat.1", "TC.H2228.Criz.1", "TC.H2286.Dasat.1", "TC.H3122.Criz.1", "TC.H3122.Criz.2", "TC.H366.Dasat.1", "TC.HCC4006.Erl.1", "TC.HCC78.Criz.1", "TC.HCC78.Criz.2", "TC.HCC827.Erl.1", "TC.PC9.Erl.1", "TC.PC9.Erl.2", "TC.STE.1.Criz.1", "parent", "Node.ID", "norm.ppibetween", "pepdegree", "pepbetween")  

colnames(gz.cf.good.col.names) <- good.col.names

#For the experiment groups of interest, make a list where each element is the names of the experiments for that group and the name of the element is the name of the set.

good_experiments <- list(c("SEPTM.H3122.Criz.1", "SEPTM.H3122.Criz.2", "SEPTM.H3122.Criz.3", "TC.H3122.Criz.1", "TC.H3122.Criz.2"), c("TC.HCC78.Criz.1", "TC.HCC78.Criz.2"), c("SEPTM.PC9.Erl.1", "SEPTM.PC9.Erl.2", "SEPTM.PC9.Erl.3", "TC.PC9.Erl.1", "TC.PC9.Erl.2"), c("SEPTM.H3122.Criz.1", "SEPTM.H3122.Criz.2", "SEPTM.H3122.Criz.3", "TC.H3122.Criz.1", "TC.H3122.Criz.2", "TC.HCC78.Criz.1", "TC.HCC78.Criz.2", "TC.H2228.Criz.1", "TC.STE.1.Criz.1"), c("SEPTM.PC9.Erl.1", "SEPTM.PC9.Erl.2", "SEPTM.PC9.Erl.3", "TC.PC9.Erl.1", "TC.PC9.Erl.2", "TC.HCC4006.Erl.1", "TC.HCC827.Erl.1"), c("TC.H2286.Dasat.1", "TC.H366.Dasat.1"), c("SEPTM.H3122.Criz.1", "SEPTM.H3122.Criz.2", "SEPTM.H3122.Criz.3", "TC.H3122.Criz.1", "TC.H3122.Criz.2", "TC.HCC78.Criz.1", "TC.HCC78.Criz.2", "TC.H2228.Criz.1", "TC.STE.1.Criz.1", "SEPTM.PC9.Erl.1", "SEPTM.PC9.Erl.2", "SEPTM.PC9.Erl.3", "TC.PC9.Erl.1", "TC.PC9.Erl.2", "TC.HCC4006.Erl.1", "TC.HCC827.Erl.1", "TC.H2286.Dasat.1", "TC.H366.Dasat.1", "TC.H1781.Afat.1"))

names(good_experiments) <- c("h3122.criz", "hcc78.criz", "pc9.erl", "all.criz", "all.erl", "all.dasat", "all.drug")

#Change the 0's to NA's so they won't get counted when calculating medians
gz.cf.good.col.names.na <- gz.cf.good.col.names
gz.cf.good.col.names.na[gz.cf.good.col.names.na == 0] <- NA

#Keep only the rows for sites--these have NodeID = peptide
gz.cf.good.col.names.na <- gz.cf.good.col.names.na[ which(gz.cf.good.col.names.na$Node.ID == "peptide"),]

#Calculate the median of each site for the experiments in each group; only calculate the median if there are at least two reps in the set; otherwise return NA
group_meds <- sapply(1:length(good_experiments),function(x){rowMedians_w_reps_df(gz.cf.good.col.names.na[good_experiments[[x]]])})
group_meds <- as.data.frame(group_meds)
rownames(group_meds) <- gz.cf.good.col.names.na$id
colnames(group_meds) <- names(good_experiments)

#Count number of non-NA sites for each set
num.sites <- apply(group_meds, 2, function(x) {sum(!is.na(x))})

#Select the significantly drug-affected sites for each experiment group. These are sites where the median is at least 2.25-fold
sig.site.meds.list <- lapply(names(good_experiments), function(x) {get.sig.sites(site.df = group_meds, column = x, threshold = 2.25, filepath = sig.site.meds.filepath)})
names(sig.site.meds.list) <- names(good_experiments)

#Tally the number of sites in each cluster
all_tally <- plyr::count(CCCN_sites, var = "Cluster")
colnames(all_tally)[2] <- "AllNumInCluster"

#Now calculate the number of sites that are not in each cluster. First find the total number of sites. Then
#subtract the number in each cluster from the total.
num_sites <- nrow(CCCN_sites)
all_tally$AllNumOutCluster <- num_sites - all_tally$AllNumInCluster

#Do cluster enrichment for the selected sites in each experiment group
enrich.list <- lapply(1:length(good_experiments),function(x){cluster_enrichment(CCCN_sites, sig.site.meds.list[[x]], all_tally)})

#For each experiment group, select clusters where the corrected enrichment p-value < 0.05 
enrich.list.formatted <- lapply(1:length(enrich.list),function(x){format_enrichment_table(enrich.list[[x]], names(good_experiments)[x], p_value = 0.05)})

#Merge the enriched clusters for all experiment groups into a single table. (Reduce is a function that sequentially performs the joining function on elements of the list so you end up with a single table) 
enrich.table <- Reduce(full_join, enrich.list.formatted)

enrich.table$num_set <- rowSums(!is.na(enrich.table[2:8]))

write.table(enrich.table, file = paste(results_table_file_path, "enrichment_results_meds_05_final.txt", sep=""), sep = "\t", row.names = FALSE, quote = FALSE)

#Calculate number of enriched clusters for each group and the mean number of enriched clusters
num_enriched <- apply(enrich.table[2:8], 2, function(x) {sum(!is.na(x))})
mean_num_enriched <- mean(num_enriched) #40.14286

```
##Heatmaps of Interesting Clusters
Two kinds of heatmaps are made. Both show the sites in the cluster as rows and the experiment groups as columns. One heatmap highlights the significant sites in the cluster--sites whose median value in the experiment group is up > 2.25-fold are colored yellow and sites whose median value in the experiment group that are < 2.25-fold are colored blue. The other heatmap shows the ratio for all sites in the cluster using a blue (low) to yellow (high) gradient. Median values of experiments within a group are plotted.

#Cluster 130.141.111
Cluster 130.141.111 is the most enriched cluster for the hcc78.criz and all.dasat sample groups. It is also enriched (corrected p-value < 0.05) in the h3122.criz, pc9.erl, and all.criz groups. In addition to heatmaps of the full cluster, heatmaps for subsets of sites in the cluster that have common function/regulation are also made: negative regulation of growth factor signaling, SRC substrates, ABL-family substrates, and EGFR substrates

```{r make heatmaps 130.141.111}

#Make heatmap showing significantly changed sites in 130.141.111; include all experiment groups even though cluster is not enriched in a couple of cases
sig.130.141.111 <- make.sig.site.heatmap.full("130.141.111", enrich.table, sig.site.meds.list, CCCN_sites, all_exps = TRUE, filepath = heatmap_path_130.141.111, filename = "medians.130.141.111.sig.sites.heatmap.jpeg", image_width=6, image_height=20)

#Make heatmap of 130.141.111 showing median values 
meds.130.141.111 <- make.cluster.heatmap.full(exp = names(good_experiments), rep_list = good_experiments, cluster = "130.141.111", CCCN_sites, gz.cf.good.col.names, filepath = heatmap_path_130.141.111, filename ="medians.130.141.111.heatmap.jpeg", image_width = 6, image_height = 20, aggregate_reps = "median", custom_order = TRUE, custom_order_vector = rownames(sig.130.141.111))

#Make sig site and median heatmaps for subset of sites from cluster 130.141.111 that have interesting function or regulation in common

#####################
#Negative regulation of growth factor signaling (cluster 130.141.111)
neg_reg <- c("PTPN6 p Y536","PTPN6 p Y564","PTPRA p Y798", "ERRFI1 p Y394", "EPS8 p Y525", "TNK2 p Y859", "MAPK14 p Y182")

sig.130.141.111.neg.reg <- make.sig.site.heatmap.full("130.141.111", enrich.table, sig.site.meds.list, CCCN_sites, all_exps = TRUE, filepath = heatmap_path_130.141.111, filename = "medians.130.141.111.sig.sites.neg.reg.heatmap.jpeg", image_width=6, image_height=6, entire_cluster = FALSE, site_list = neg_reg)

meds.130.141.111.neg.reg <- make.cluster.heatmap.full(exp = names(good_experiments), rep_list = good_experiments, cluster = "130.141.111", CCCN_sites, gz.cf.good.col.names, filepath = heatmap_path_130.141.111, filename ="medians.130.141.111.neg.reg.heatmap.jpeg", image_width = 6, image_height = 6, aggregate_reps = "median", custom_order = TRUE, custom_order_vector = rownames(sig.130.141.111.neg.reg), entire_cluster = FALSE, site_list = neg_reg)

#####################
#SRC substrates in 130.141.111
src_substrates <- c("ARHGAP35 p Y1105","CDK5 Y15", "CTNND1 p Y228", "PRKCD p Y334", "PTK2 p Y576", "PTPN6 p Y536", "PTPN6 p Y564", "PTPRA p Y798", "PTTG1IP p Y174", "PXN p Y88", "STAT3 p Y705")

sig.130.141.111.src <- make.sig.site.heatmap.full("130.141.111", enrich.table, sig.site.meds.list, CCCN_sites, all_exps = TRUE, filepath = heatmap_path_130.141.111, filename = "medians.130.141.111.sig.sites.src.heatmap.jpeg", image_width=6, image_height=6, entire_cluster = FALSE, site_list = src_substrates)

meds.130.141.111.src <- make.cluster.heatmap.full(exp = names(good_experiments), rep_list = good_experiments, cluster = "130.141.111", CCCN_sites, gz.cf.good.col.names, filepath = heatmap_path_130.141.111, filename ="medians.130.141.111.src.heatmap.jpeg", image_width = 6, image_height = 6, aggregate_reps = "median", custom_order = TRUE, custom_order_vector = rownames(sig.130.141.111.src), entire_cluster = FALSE, site_list = src_substrates, color = "yellow")

#############
#Substrates of ABL-family kinases
abl_substrates = c("ARHGAP35 p Y1105", "CDK5 p Y15", "EGFR p Y1197", "PTPN11 p Y584", "PTPN6 p Y536", "PTPN6 p Y564", "PXN p Y118", "WASL p Y256")

sig.130.141.111.abl <- make.sig.site.heatmap.full("130.141.111", enrich.table, sig.site.meds.list, CCCN_sites, all_exps = TRUE, filepath = heatmap_path_130.141.111, filename = "medians.130.141.111.sig.sites.abl.heatmap.jpeg", image_width=6, image_height=6, entire_cluster = FALSE, site_list = abl_substrates)

meds.130.141.111.abl <- make.cluster.heatmap.full(exp = names(good_experiments), rep_list = good_experiments, cluster = "130.141.111", CCCN_sites, gz.cf.good.col.names, filepath = heatmap_path_130.141.111, filename ="medians.130.141.111.abl.heatmap.jpeg", image_width = 6, image_height = 6, aggregate_reps = "median", custom_order = TRUE, custom_order_vector = rownames(sig.130.141.111.abl), entire_cluster = FALSE, site_list = abl_substrates, color = "yellow")

##############
#Substrates and/or downstream effectors of EGFR
downstream_egfr = c("ARHGAP35 p Y1105", "GAB1 p Y659", "GPRC5A p Y350", "PTPN11 p Y584", "STAT3 p Y705", "CTNND1 p Y228", "EGFR p Y1197", "PRKCD p Y334")

sig.130.141.111.downstream.egfr <- make.sig.site.heatmap.full("130.141.111", enrich.table, sig.site.meds.list, CCCN_sites, all_exps = TRUE, filepath = heatmap_path_130.141.111, filename = "medians.130.141.111.sig.sites.downstream.egfr.heatmap.jpeg", image_width=6, image_height=6, entire_cluster = FALSE, site_list = downstream_egfr)

meds.130.141.111.downstream.egfr <- make.cluster.heatmap.full(exp = names(good_experiments), rep_list = good_experiments, cluster = "130.141.111", CCCN_sites, gz.cf.good.col.names, filepath = heatmap_path_130.141.111, filename ="medians.130.141.111.downstream.egfr.heatmap.jpeg", image_width = 6, image_height = 6, aggregate_reps = "median", custom_order = TRUE, custom_order_vector = rownames(sig.130.141.111.downstream.egfr), entire_cluster = FALSE, site_list = downstream_egfr, color = "yellow")

#Count number of sites in cluster 130.141.111 that are significant in at least one set
sig.count <- sig.130.141.111
sig.count$num_na <- apply(sig.count, 1, function (x){sum(is.na(x))})
one.set <- sum(sig.count$num_na < 7) #49
```

#Cluster 180.173.39
Cluster 180.173.39 is the most enriched cluster for pc9.erl and is also highly enriched for h3122.criz. Sites in this cluster were only observed for these two experiment groups and only the SEPTM set of experiments, so only pc9.erl and h3122.criz will be shown in the heatmaps. This cluster is interesting because it consists of mostly acetylation sites, many of which have a role in regulating transcription.

```{r make heatmaps 180.173.39}

#Only plot data for h3122.criz and pc9.erl experiment groups
sig.site.selected <- sig.site.meds.list[c("h3122.criz", "pc9.erl")]

#Make sig site heatmap
sig.180.173.39 <- make.sig.site.heatmap.full("180.173.39", enrich.table, sig.site.selected, CCCN_sites, all_exps = TRUE, filepath = heatmap_path_180.173.39, filename = "medians.180.173.39.sig.sites.heatmap.jpeg", image_width=4, image_height=10)

#Make medians heatmap
meds.180.173.39 <- make.cluster.heatmap.full(exp = names(sig.site.selected), rep_list = good_experiments, cluster = "180.173.39", CCCN_sites, gz.cf.good.col.names, filepath = heatmap_path_180.173.39, filename ="medians.180.173.39.heatmap.jpeg", image_width = 4, image_height = 10, aggregate_reps = "median", custom_order = TRUE, custom_order_vector = rownames(sig.180.173.39))
```

#Cluster 38.41.40
Cluster 38.41.40 which has a significant enrichment p-value for the all.criz, all.erl, all.dasat, and all.drug groups, is one of the best examples of a cluster whose sites are affected by all TKIs tested. Plot all experiment groups--all groups have some observations although there are no significant sites in the h3122.criz and pc9.erl groups.

```{r make heatmaps 38.41.40}
#Make sig site heatmap for 38.41.40
sig.38.41.40 <- make.sig.site.heatmap.full("38.41.40", enrich.table, sig.site.meds.list, CCCN_sites, all_exps = TRUE, filepath = heatmap_path_38.41.40, filename = "medians.38.41.40.sig.sites.heatmap.jpeg", image_width=6, image_height=16)

#Make medians heatmap
meds.38.41.40 <- make.cluster.heatmap.full(exp = names(good_experiments), rep_list = good_experiments, cluster = "38.41.40", CCCN_sites, gz.cf.good.col.names, filepath = heatmap_path_38.41.40, filename ="medians.38.41.40.heatmap.jpeg", image_width = 6, image_height = 16, aggregate_reps = "median", custom_order = TRUE, custom_order_vector = rownames(sig.38.41.40))

####################
#Actin-related genes in 38.41.40 with sig PTMs in all.drug
actin_related <- c("ARAP2 p Y77", "ABLIM1 p Y357", "CTTN p S405", "CTNNAL1 p Y536", "EMD p Y94", "RALGPS2 p Y420", "SPRED1 p Y292")

sig.38.41.40.actin <- make.sig.site.heatmap.full("38.41.40", enrich.table, sig.site.meds.list, CCCN_sites, all_exps = TRUE, filepath = heatmap_path_38.41.40, filename = "medians.38.41.40.sig.sites.actin.heatmap.jpeg", image_width=6, image_height=6, entire_cluster = FALSE, site_list = actin_related)

meds.38.41.40.actin <- make.cluster.heatmap.full(exp = names(good_experiments), rep_list = good_experiments, cluster = "38.41.40", CCCN_sites, gz.cf.good.col.names, filepath = heatmap_path_38.41.40, filename ="medians.38.41.40.actin.heatmap.jpeg", image_width = 6, image_height = 6, aggregate_reps = "median", custom_order = TRUE, custom_order_vector = rownames(sig.38.41.40.actin), entire_cluster = FALSE, site_list = actin_related)

###############
#PTMs in 38.41.40 that are sig up in all.erl and have known interactions with the EGFR pathway
egfr_related <- c("ORAI1 p Y300", "PIK3R2 p Y460", "REPS1 p Y126", "SLC9A1 p Y683", "PTPRK p S856", "SNAP23 p Y139", "EPHB2 p Y577", "ZDHHC5 p Y630")

sig.38.41.40.egfr <- make.sig.site.heatmap.full("38.41.40", enrich.table, sig.site.meds.list, CCCN_sites, all_exps = TRUE, filepath = heatmap_path_38.41.40, filename = "medians.38.41.40.sig.sites.egfr.heatmap.jpeg", image_width=6, image_height=6, entire_cluster = FALSE, site_list = egfr_related)

meds.38.41.40.egfr <- make.cluster.heatmap.full(exp = names(good_experiments), rep_list = good_experiments, cluster = "38.41.40", CCCN_sites, gz.cf.good.col.names, filepath = heatmap_path_38.41.40, filename ="medians.38.41.40.egfr.heatmap.jpeg", image_width = 6, image_height = 6, aggregate_reps = "median", custom_order = TRUE, custom_order_vector = rownames(sig.38.41.40.egfr), entire_cluster = FALSE, site_list = egfr_related)
```

##Plot CFN for Interesting Clusters

1. Calculate medians for experiments groups for all rows gz.cf.good.col.names. (Note: gz.cf.good.col.names has the genes with NA as name removed and has the ratio column names standardized.) This is very similar to group_meds except that it will include the rows where Node.ID is gene. Keeping the gene rows will make it possible to color the gene nodes in Cytoscape. Also, don't require at least two observations to return a median (use rowMedians instead of rowMedians_w_reps_df). Add all of the metadata columns from gz.cf to the medians table.

2. To make network in Cytoscape see make.cfn.cytoscape.files in cluster-enrichment-function-v1.R and graph.cfn.cccn in Generate_CCCN_CFN.R and graph.cluster in CFN_CCCN_Analysis.R. Also all.ratio.styles. 


```{r plot cfn}
#Change the 0's to NA's so they won't get counted when calculating medians
gz.cf.good.col.names.all.na <- gz.cf.good.col.names
gz.cf.good.col.names.all.na[gz.cf.good.col.names.all.na == 0] <- NA

#Calculate the median of each site for the experiments in each group; calculate the median even if there there is only one rep in #the set; otherwise return NA; change the NA's to 0's for plotting node colors and sizes in Cytoscape; add the non-ratio columns #from gz.cf.good.col.names.all.na to the median table
group_meds_all <- sapply(1:length(good_experiments),function(x){rowMedians(gz.cf.good.col.names.all.na[good_experiments[[x]]])})
group_meds_all <- as.data.frame(group_meds_all)
colnames(group_meds_all) <- names(good_experiments)
group_meds_all[is.na(group_meds_all)] <- 0
group_meds_all <- cbind(gz.cf.good.col.names.all.na[1:16], gz.cf.good.col.names.all.na[42:46], group_meds_all)

#Fix annotation of KAT7, so it is listed as an acetyltransferase
group_meds_all[which(group_meds_all$id == "KAT7"), "nodeType"] <- "acetyltransferase"

plot_cluster_cfn(cluster = "38.41.40", cluster_site_mapping_table = CCCN_sites, ratio_table = group_meds_all, cfn = gzalltgene.physical.cfn.merged)

all.ratio.styles2(ratiocols = names(good_experiments))

plot_cluster_cfn(cluster = "180.173.39", cluster_site_mapping_table = CCCN_sites, ratio_table = group_meds_all, cfn = gzalltgene.physical.cfn.merged)
  
all.ratio.styles2(ratiocols = names(good_experiments))

plot_cluster_cfn(cluster = "130.141.111", cluster_site_mapping_table = CCCN_sites, ratio_table = group_meds_all, cfn = gzalltgene.physical.cfn.merged)
  
all.ratio.styles2(ratiocols = names(good_experiments))

```
##Save Useful Files

```{r save files}

#Save file with median values for sites in each experiment group--group_meds
saveRDS(group_meds, file = paste(data_path, "group_meds.rds", sep="")) 

#Save file with significantly changed sites (absolute value of median > 2.25)--sig.site.meds.list
saveRDS(sig.site.meds.list, file = paste(data_path, "sig_site_meds_list.rds", sep="")) 

#Save file that is like gz.cf but lists group medians instead of ratios for individual experiments
saveRDS(group_meds_all, file = paste(data_path, "group_meds_all.rds", sep="")) 

#Save file with list of experiment groups
saveRDS(good_experiments, file = paste(data_path, "good_experiments.rds", sep="")) 


```

